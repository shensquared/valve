<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valve - Class Schedule</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      background: #f5f5f5;
      padding: 20px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    select {
      padding: 8px 16px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }

    .schedule-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      border: 2px solid #333;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      border: 2px solid #333;
    }

    .week-header {
      background: #e3e3e3;
      font-weight: 600;
      border: 2px solid #333;
      width: 60px;
      min-width: 60px;
      max-width: 60px;
    }

    .date-row td {
      font-weight: bold;
      font-size: 13px;
      border: 2px solid #333;
      min-height: 60px;
      height: 60px;
      vertical-align: middle;
    }

    .label-row td {
      font-size: 11px;
      min-height: 60px;
      height: 60px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Valve</h1>
    <select id="semesterSelect">
    </select>
  </div>

  <div class="schedule-container">
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Week</th>
          <th>Monday</th>
          <th>Tuesday</th>
          <th>Wednesday</th>
          <th>Thursday</th>
          <th>Friday</th>
        </tr>
      </thead>
      <tbody id="scheduleBody">
        <tr>
          <td colspan="6" style="padding: 40px; color: #999;">
            Select a semester to begin
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const semesterFiles = [
      { key: 'spring26', path: 'semesters/spring26.json' },
      { key: 'fall25', path: 'semesters/fall25.json' }
    ];

    let colors = null;
    let currentSemester = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // Load colors
      try {
        colors = await fetchJSON('semesters/colors.json');
      } catch (e) {
        console.error('Failed to load colors.json:', e);
      }

      // Populate semester select
      const select = document.getElementById('semesterSelect');
      for (const sem of semesterFiles) {
        const option = document.createElement('option');
        option.value = sem.path;
        option.textContent = sem.key;
        select.appendChild(option);
      }

      select.addEventListener('change', async (e) => {
        if (e.target.value) {
          await loadSemester(e.target.value);
        }
      });

      // Auto-load first semester
      if (semesterFiles.length > 0) {
        select.value = semesterFiles[0].path;
        await loadSemester(semesterFiles[0].path);
      }
    });

    async function loadSemester(path) {
      try {
        currentSemester = await fetchJSON(path);
        const select = document.getElementById('semesterSelect');
        select.options[select.selectedIndex].textContent = currentSemester.name;
        renderSchedule();
      } catch (err) {
        console.error('Failed to load semester:', err);
        alert('Failed to load semester: ' + err.message);
      }
    }

    async function fetchJSON(path) {
      console.log('Fetching:', path);
      const response = await fetch(path);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      console.log('Loaded:', path);
      return data;
    }

    function generateWeeks(firstMonday, lastClassDate) {
      const weeks = [];
      let current = new Date(firstMonday + 'T00:00:00');
      const end = new Date(lastClassDate + 'T00:00:00');
      let weekNum = 1;

      while (current <= end) {
        const week = { number: weekNum, days: [] };
        for (let i = 0; i < 5; i++) {
          const day = new Date(current);
          day.setDate(day.getDate() + i);
          week.days.push({
            dateStr: day.toISOString().split('T')[0],
            display: day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          });
        }
        weeks.push(week);
        current.setDate(current.getDate() + 7);
        weekNum++;
      }
      return weeks;
    }

    function getHoliday(dateStr) {
      if (!currentSemester?.holidays) return null;
      return currentSemester.holidays.find(h => h.date === dateStr);
    }

    function getDateLabels(dateStr) {
      if (!currentSemester || !colors) return [];
      const labels = [];
      const dateKeys = Object.keys(colors.dates);
      for (const key of dateKeys) {
        if (currentSemester[key] === dateStr) {
          labels.push(key);
        }
      }
      return labels;
    }

    function resolveColor(value) {
      if (!value) return null;
      // If it's a hex color, return as-is
      if (value.startsWith('#')) return value;
      // If it's a palette reference like "eecs-red", resolve it
      if (value.includes('-')) {
        const [palette, color] = value.split('-');
        return colors?.palettes?.[palette]?.[color] || null;
      }
      return null;
    }

    function getColor(level) {
      const value = colors?.levels?.[level];
      return resolveColor(value);
    }

    function getDateColor(dateStr) {
      const labels = getDateLabels(dateStr);
      let highestLevel = null;
      for (const label of labels) {
        const level = colors.dates[label];
        if (level === 'High') return getColor('High');
        if (level === 'Medium') highestLevel = 'Medium';
      }
      return highestLevel ? getColor(highestLevel) : null;
    }

    function getHolidayColor(holiday) {
      if (!colors) return '#ffebee';
      const level = colors.holidays[holiday.name];
      if (level) {
        return getColor(level);
      }
      return resolveColor(colors.holidays.default) || colors.holidays.default;
    }

    function formatLabel(key) {
      return key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
    }

    function renderSchedule() {
      if (!currentSemester) {
        console.error('No current semester');
        return;
      }
      console.log('Rendering:', currentSemester.name);

      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = '';

      const weeks = generateWeeks(currentSemester.firstMonday, currentSemester.lastClassDate);

      weeks.forEach(week => {
        // Collect day info
        const dayInfo = week.days.map(day => {
          const holiday = getHoliday(day.dateStr);
          const dateLabels = getDateLabels(day.dateStr);
          let bgColor = null;
          let textColor = null;
          let labels = [];

          if (holiday) {
            bgColor = getHolidayColor(holiday);
            labels.push(holiday.name);
          }

          // Check date labels for High (bg) or Medium (text)
          for (const label of dateLabels) {
            const level = colors?.dates?.[label];
            if (level === 'High') {
              bgColor = getColor('High');
            } else if (level === 'Medium') {
              textColor = getColor('Medium');
            }
            labels.push(formatLabel(label));
          }

          return { day, bgColor, textColor, labels };
        });

        // Date row
        const dateRow = document.createElement('tr');
        dateRow.className = 'date-row';
        const weekTd = document.createElement('td');
        weekTd.className = 'week-header';
        weekTd.rowSpan = 2;
        weekTd.textContent = week.number;
        dateRow.appendChild(weekTd);
        dayInfo.forEach(({ day }) => {
          const td = document.createElement('td');
          td.textContent = day.display;
          dateRow.appendChild(td);
        });
        tbody.appendChild(dateRow);

        // Label row (holidays/milestones)
        const labelRow = document.createElement('tr');
        labelRow.className = 'label-row';
        dayInfo.forEach(({ bgColor, textColor, labels }) => {
          const td = document.createElement('td');
          if (bgColor) td.style.backgroundColor = bgColor;
          if (textColor) td.style.color = textColor;
          td.innerHTML = labels.join('<br>');
          labelRow.appendChild(td);
        });
        tbody.appendChild(labelRow);

      });
    }
  </script>
</body>
</html>
