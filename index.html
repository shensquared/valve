<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valve - Class Schedule</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      background: #f5f5f5;
      padding: 20px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    select {
      padding: 8px 16px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }

    .schedule-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
      min-width: 800px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      border: 2px solid #333;
      table-layout: fixed;
    }

    th, td {
      padding: 10px;
      text-align: center;
      overflow: hidden;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      border: 2px solid #333;
    }

    th:first-child {
      width: 60px;
    }

    th:not(:first-child) {
      width: calc((100% - 60px) / 5);
    }

    .week-header {
      background: #e3e3e3;
      font-weight: 600;
      border: 2px solid #333;
      width: 60px;
      min-width: 60px;
      max-width: 60px;
    }

    .date-row td {
      font-weight: bold;
      font-size: 13px;
      border: 2px solid #333;
      min-height: 40px;
      height: 40px;
      vertical-align: middle;
    }

    .label-row td {
      font-size: 11px;
      min-height: 60px;
      height: 60px;
      vertical-align: middle;
    }

    .event-row td {
      font-size: 12px;
      min-height: 30px;
      height: 30px;
      vertical-align: middle;
      background: #fafafa;
    }

    .controls {
      display: flex;
      gap: 30px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-weight: 600;
      color: #333;
    }

    .day-matrix {
      border-collapse: collapse;
    }

    .day-matrix th,
    .day-matrix td {
      padding: 4px 8px;
      text-align: center;
    }

    .day-matrix th {
      font-weight: 600;
      font-size: 12px;
      color: #666;
    }

    .event-label {
      font-weight: 600;
      text-align: right;
      padding-right: 12px;
    }

    .day-btn {
      width: 24px;
      height: 24px;
      border: 2px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-btn:hover {
      border-color: #999;
    }

    .day-btn.active {
      background: #333;
      border-color: #333;
    }

    .none-btn {
      border-style: dashed;
    }

    .toggle-buttons {
      display: flex;
      gap: 0;
    }

    .toggle-btn {
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn:first-child {
      border-radius: 4px 0 0 4px;
    }

    .toggle-btn:last-child {
      border-radius: 0 4px 4px 0;
      border-left: none;
    }

    .toggle-btn.active {
      background: #333;
      color: white;
      border-color: #333;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="MIT Valve" height="100">
  </div>

  <div class="controls">
    <div class="control-group">
      <label>Term</label>
      <select id="semesterSelect">
      </select>
    </div>
    <div class="control-group">
      <label>Has Final?</label>
      <div class="toggle-buttons">
        <button class="toggle-btn active" data-value="yes">Yes</button>
        <button class="toggle-btn" data-value="no">No</button>
      </div>
    </div>
    <div class="control-group">
      <table class="day-matrix">
        <thead>
          <tr>
            <th></th>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>R</th>
            <th>F</th>
            <th>None</th>
          </tr>
        </thead>
        <tbody>
          <tr data-event="lecture">
            <td class="event-label">Lecture</td>
            <td><button class="day-btn" data-day="M"></button></td>
            <td><button class="day-btn" data-day="T"></button></td>
            <td><button class="day-btn" data-day="W"></button></td>
            <td><button class="day-btn" data-day="R"></button></td>
            <td><button class="day-btn" data-day="F"></button></td>
            <td><button class="day-btn none-btn" data-day="none"></button></td>
          </tr>
          <tr data-event="lab">
            <td class="event-label">Lab</td>
            <td><button class="day-btn" data-day="M"></button></td>
            <td><button class="day-btn" data-day="T"></button></td>
            <td><button class="day-btn" data-day="W"></button></td>
            <td><button class="day-btn" data-day="R"></button></td>
            <td><button class="day-btn" data-day="F"></button></td>
            <td><button class="day-btn none-btn" data-day="none"></button></td>
          </tr>
          <tr data-event="recitation">
            <td class="event-label">Recitation</td>
            <td><button class="day-btn" data-day="M"></button></td>
            <td><button class="day-btn" data-day="T"></button></td>
            <td><button class="day-btn" data-day="W"></button></td>
            <td><button class="day-btn" data-day="R"></button></td>
            <td><button class="day-btn" data-day="F"></button></td>
            <td><button class="day-btn none-btn" data-day="none"></button></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="schedule-container">
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Week</th>
          <th>Monday</th>
          <th>Tuesday</th>
          <th>Wednesday</th>
          <th>Thursday</th>
          <th>Friday</th>
        </tr>
      </thead>
      <tbody id="scheduleBody">
        <tr>
          <td colspan="6" style="padding: 40px; color: #999;">
            Select a semester to begin
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const semesterFiles = [
      { key: 'spring26', path: 'semesters/spring26.json' },
      { key: 'fall25', path: 'semesters/fall25.json' }
    ];

    let colors = null;
    let currentSemester = null;
    let hasFinal = true;
    let eventDays = {
      lecture: new Set(),
      lab: new Set(),
      recitation: new Set()
    };

    document.addEventListener('DOMContentLoaded', async () => {
      // Load colors
      try {
        colors = await fetchJSON('semesters/colors.json');
      } catch (e) {
        console.error('Failed to load colors.json:', e);
      }

      // Populate semester select
      const select = document.getElementById('semesterSelect');
      for (const sem of semesterFiles) {
        const option = document.createElement('option');
        option.value = sem.path;
        option.textContent = sem.key;
        select.appendChild(option);
      }

      select.addEventListener('change', async (e) => {
        if (e.target.value) {
          await loadSemester(e.target.value);
        }
      });

      // Auto-load first semester
      if (semesterFiles.length > 0) {
        select.value = semesterFiles[0].path;
        await loadSemester(semesterFiles[0].path);
      }

      // Day matrix toggle logic
      document.querySelectorAll('.day-matrix .day-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const row = btn.closest('tr');
          const eventType = row.dataset.event;
          const day = btn.dataset.day;
          if (day === 'none') {
            // Clear all days in this row
            row.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            eventDays[eventType].clear();
          } else {
            // Deselect "None" for this row
            row.querySelector('.none-btn').classList.remove('active');
            btn.classList.toggle('active');
            if (btn.classList.contains('active')) {
              eventDays[eventType].add(day);
            } else {
              eventDays[eventType].delete(day);
            }
          }
          renderSchedule();
        });
      });

      // Has Final toggle logic
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          hasFinal = btn.dataset.value === 'yes';
          renderSchedule();
        });
      });
    });

    async function loadSemester(path) {
      try {
        currentSemester = await fetchJSON(path);
        const select = document.getElementById('semesterSelect');
        select.options[select.selectedIndex].textContent = currentSemester.name;
        renderSchedule();
      } catch (err) {
        console.error('Failed to load semester:', err);
        alert('Failed to load semester: ' + err.message);
      }
    }

    async function fetchJSON(path) {
      console.log('Fetching:', path);
      const response = await fetch(path);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      console.log('Loaded:', path);
      return data;
    }

    function generateWeeks(firstMonday, lastClassDate) {
      const weeks = [];
      let current = new Date(firstMonday + 'T00:00:00');
      const end = new Date(lastClassDate + 'T00:00:00');
      let weekNum = 1;

      // Validate firstMonday is actually a Monday (0=Sun, 1=Mon, ...)
      if (current.getDay() !== 1) {
        const dayName = current.toLocaleDateString('en-US', { weekday: 'long' });
        console.error(`firstMonday (${firstMonday}) is a ${dayName}, not Monday!`);
        alert(`Warning: firstMonday (${firstMonday}) is a ${dayName}, not Monday!`);
      }

      while (current <= end) {
        const week = { number: weekNum, days: [] };
        for (let i = 0; i < 5; i++) {
          const day = new Date(current);
          day.setDate(day.getDate() + i);
          week.days.push({
            dateStr: day.toISOString().split('T')[0],
            display: day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          });
        }
        weeks.push(week);
        current.setDate(current.getDate() + 7);
        weekNum++;
      }
      return weeks;
    }

    function getHoliday(dateStr) {
      if (!currentSemester?.holidays) return null;
      return currentSemester.holidays.find(h => h.date === dateStr);
    }

    function isInFinalPeriod(dateStr) {
      if (!currentSemester?.finalPeriodStart || !currentSemester?.finalPeriodEnd) return false;
      return dateStr >= currentSemester.finalPeriodStart && dateStr <= currentSemester.finalPeriodEnd;
    }

    function isBeforeClasses(dateStr) {
      if (!currentSemester?.startDate) return false;
      return dateStr < currentSemester.startDate;
    }

    function isAfterClasses(dateStr) {
      if (!currentSemester?.lastClassDate) return false;
      return dateStr > currentSemester.lastClassDate;
    }

    function getDateLabels(dateStr) {
      if (!currentSemester || !colors) return [];
      const labels = [];
      const dateKeys = Object.keys(colors.dates);
      for (const key of dateKeys) {
        if (currentSemester[key] === dateStr) {
          // Skip firstMonday label
          if (key === 'firstMonday') continue;
          // Filter based on hasFinal toggle
          if (hasFinal) {
            // Show HasFinal dates, hide NoFinal dates
            if (key === 'gradesDueNoFinal') continue;
          } else {
            // Show NoFinal dates, hide HasFinal/final period dates
            if (key === 'lastDueHasFinal' || key === 'gradesDueHasFinal') continue;
            if (key === 'finalPeriodStart' || key === 'finalPeriodEnd') continue;
          }
          labels.push(key);
        }
      }
      // When no final, lastClassDate is also the last due date
      if (!hasFinal && dateStr === currentSemester.lastClassDate) {
        labels.push('lastDueDate');
      }
      return labels;
    }

    function resolveColor(value) {
      if (!value) return null;
      // If it's a hex color, return as-is
      if (value.startsWith('#')) return value;
      // If it's a palette reference like "eecs-red", resolve it
      if (value.includes('-')) {
        const [palette, color] = value.split('-');
        return colors?.palettes?.[palette]?.[color] || null;
      }
      return null;
    }

    function getColor(level) {
      const value = colors?.levels?.[level];
      return resolveColor(value);
    }

    function getDateColor(dateStr) {
      const labels = getDateLabels(dateStr);
      let highestLevel = null;
      for (const label of labels) {
        const level = colors.dates[label];
        if (level === 'High') return getColor('High');
        if (level === 'Medium') highestLevel = 'Medium';
      }
      return highestLevel ? getColor(highestLevel) : null;
    }

    function getHolidayColor(holiday) {
      if (!colors) return '#ffebee';
      const level = colors.holidays[holiday.name];
      if (level) {
        return getColor(level);
      }
      return resolveColor(colors.holidays.default) || colors.holidays.default;
    }

    function formatLabel(key) {
      // Special case labels
      if (key === 'startDate') return 'First Day of Class';
      if (key === 'Monday Schedule Shift') return 'Follow Monday Schedule';
      // Remove "HasFinal" / "NoFinal" suffixes since toggle makes it clear
      let label = key
        .replace(/HasFinal$/, '')
        .replace(/NoFinal$/, '');
      return label.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
    }

    const dayIndexMap = { M: 0, T: 1, W: 2, R: 3, F: 4 };

    function getActiveEventTypes() {
      return Object.entries(eventDays)
        .filter(([_, days]) => days.size > 0)
        .map(([type, _]) => type);
    }

    function renderSchedule() {
      if (!currentSemester) {
        console.error('No current semester');
        return;
      }
      console.log('Rendering:', currentSemester.name);

      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = '';

      const endDate = hasFinal ? currentSemester.finalPeriodEnd : currentSemester.gradesDueNoFinal;
      // Find the Monday of the week containing startDate
      const startDateObj = new Date(currentSemester.startDate + 'T00:00:00');
      const dayOfWeek = startDateObj.getDay(); // 0=Sun, 1=Mon, ...
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const firstMonday = new Date(startDateObj);
      firstMonday.setDate(firstMonday.getDate() + mondayOffset);
      const firstMondayStr = firstMonday.toISOString().split('T')[0];
      const weeks = generateWeeks(firstMondayStr, endDate);
      const activeEventTypes = getActiveEventTypes();
      const rowsPerWeek = 2 + activeEventTypes.length; // date + label + event rows

      // Track event counters across weeks
      const eventCounters = {
        lecture: 1,
        lab: 1,
        recitation: 1
      };

      weeks.forEach(week => {
        // Collect day info
        const dayInfo = week.days.map((day, dayIndex) => {
          const holiday = getHoliday(day.dateStr);
          const dateLabels = getDateLabels(day.dateStr);
          const inFinals = isInFinalPeriod(day.dateStr);
          const beforeClasses = isBeforeClasses(day.dateStr);
          const afterClasses = isAfterClasses(day.dateStr);
          let bgColor = null;
          let textColor = null;
          let labels = [];

          if (holiday) {
            bgColor = getHolidayColor(holiday);
            labels.push(holiday.name);
          }

          // Mark final exam period (only if class has a final)
          if (inFinals && hasFinal) {
            labels.push('Finals');
            if (!bgColor) bgColor = '#fff3cd';  // Light yellow for finals
          }

          // Check date labels for High (bg) or Medium (text)
          for (const label of dateLabels) {
            const level = colors?.dates?.[label];
            if (level === 'High') {
              bgColor = getColor('High');
            } else if (level === 'Medium') {
              textColor = getColor('Medium');
            }
            labels.push(formatLabel(label));
          }

          return { day, dayIndex, holiday, inFinals, beforeClasses, afterClasses, bgColor, textColor, labels };
        });

        // Date row
        const dateRow = document.createElement('tr');
        dateRow.className = 'date-row';
        const weekTd = document.createElement('td');
        weekTd.className = 'week-header';
        weekTd.rowSpan = rowsPerWeek;
        weekTd.textContent = week.number;
        dateRow.appendChild(weekTd);
        dayInfo.forEach(({ day, beforeClasses }) => {
          const td = document.createElement('td');
          if (!beforeClasses) {
            td.textContent = day.display;
            const dateColor = resolveColor(colors?.date) || colors?.date;
            if (dateColor) {
              td.style.backgroundColor = dateColor;
            }
          }
          dateRow.appendChild(td);
        });
        tbody.appendChild(dateRow);

        // Label row (holidays/milestones)
        const labelRow = document.createElement('tr');
        labelRow.className = 'label-row';

        // Check if entire week is Spring Break (has both Start and End)
        const hasSpringBreakStart = dayInfo.some(({ holiday }) =>
          holiday?.name?.toLowerCase().includes('spring break start')
        );
        const hasSpringBreakEnd = dayInfo.some(({ holiday }) =>
          holiday?.name?.toLowerCase().includes('spring break end')
        );
        const isSpringBreakWeek = hasSpringBreakStart && hasSpringBreakEnd;

        // Check for Thanksgiving week (Thu + Fri holidays)
        const thanksgivingDays = dayInfo.filter(({ holiday }) =>
          holiday?.name?.toLowerCase().includes('thanksgiving')
        );
        const isThanksgivingWeek = thanksgivingDays.length >= 2;

        // Check for finals period days
        const finalsDays = dayInfo.map((info, idx) => ({ ...info, idx }))
          .filter(({ inFinals }) => inFinals && hasFinal);
        const hasFinalsInWeek = finalsDays.length > 0;

        if (isSpringBreakWeek) {
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'Spring Break';
          td.style.backgroundColor = getHolidayColor({ name: 'Spring Break' });
          labelRow.appendChild(td);
        } else if (isThanksgivingWeek) {
          // Render Mon-Wed normally, merge Thu-Fri for Thanksgiving
          dayInfo.slice(0, 3).forEach(({ beforeClasses, bgColor, textColor, labels }) => {
            const td = document.createElement('td');
            if (!beforeClasses) {
              if (bgColor) td.style.backgroundColor = bgColor;
              if (textColor) td.style.color = textColor;
              td.innerHTML = labels.join('<br>');
            }
            labelRow.appendChild(td);
          });
          const td = document.createElement('td');
          td.colSpan = 2;
          td.textContent = 'Thanksgiving';
          td.style.backgroundColor = getHolidayColor({ name: 'Thanksgiving Holiday' });
          labelRow.appendChild(td);
        } else if (hasFinalsInWeek) {
          // Render non-finals days normally, merge finals days
          const firstFinalsIdx = finalsDays[0].idx;
          const finalsCount = finalsDays.length;

          // Days before finals
          dayInfo.slice(0, firstFinalsIdx).forEach(({ beforeClasses, afterClasses, bgColor, textColor, labels }) => {
            const td = document.createElement('td');
            if (!beforeClasses && !afterClasses) {
              if (bgColor) td.style.backgroundColor = bgColor;
              if (textColor) td.style.color = textColor;
              td.innerHTML = labels.join('<br>');
            }
            labelRow.appendChild(td);
          });

          // Merged finals cell
          const td = document.createElement('td');
          td.colSpan = finalsCount;

          // Only show grades due in finals cell for Fall (when it's >7 days after finals end)
          const gradesDueDate = currentSemester.gradesDueHasFinal;
          const finalEnd = new Date(currentSemester.finalPeriodEnd + 'T00:00:00');
          const gradesDue = new Date(gradesDueDate + 'T00:00:00');
          const daysDiff = (gradesDue - finalEnd) / (1000 * 60 * 60 * 24);

          if (daysDiff > 7) {
            // Fall term - grades due is next year
            const gradesDueFormatted = gradesDue.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            td.innerHTML = `Finals Period<br><small>Grades Due: ${gradesDueFormatted}</small>`;
          } else {
            td.textContent = 'Finals Period';
          }
          td.style.backgroundColor = '#fff3cd';
          labelRow.appendChild(td);

          // Days after finals (if any in same week)
          dayInfo.slice(firstFinalsIdx + finalsCount).forEach(({ beforeClasses, bgColor, textColor, labels }) => {
            const td = document.createElement('td');
            if (!beforeClasses) {
              if (bgColor) td.style.backgroundColor = bgColor;
              if (textColor) td.style.color = textColor;
              td.innerHTML = labels.join('<br>');
            }
            labelRow.appendChild(td);
          });
        } else {
          dayInfo.forEach(({ beforeClasses, bgColor, textColor, labels }) => {
            const td = document.createElement('td');
            if (!beforeClasses) {
              if (bgColor) td.style.backgroundColor = bgColor;
              if (textColor) td.style.color = textColor;
              td.innerHTML = labels.join('<br>');
            }
            labelRow.appendChild(td);
          });
        }
        tbody.appendChild(labelRow);

        // Event rows
        activeEventTypes.forEach(eventType => {
          const eventRow = document.createElement('tr');
          eventRow.className = 'event-row';
          const selectedDays = eventDays[eventType];

          dayInfo.forEach(({ dayIndex, holiday, beforeClasses, afterClasses }) => {
            const td = document.createElement('td');
            let effectiveDayKey = Object.keys(dayIndexMap).find(k => dayIndexMap[k] === dayIndex);

            // Monday Schedule Shift: treat this day as Monday
            if (holiday?.name === 'Monday Schedule Shift') {
              effectiveDayKey = 'M';
            }

            // No events before or after class period
            if (beforeClasses || afterClasses) {
              eventRow.appendChild(td);
              return;
            }

            if (selectedDays.has(effectiveDayKey)) {
              if (holiday && holiday.name !== 'Monday Schedule Shift') {
                // Holiday - no class (but Monday Shift still has class)
                td.textContent = '';
              } else {
                // Show numbered event
                const label = eventType.charAt(0).toUpperCase() + eventType.slice(1);
                td.textContent = `${label} ${eventCounters[eventType]}`;
                eventCounters[eventType]++;
                // Apply event color
                const eventColor = resolveColor(colors?.events?.[eventType]) || colors?.events?.[eventType];
                if (eventColor) {
                  td.style.backgroundColor = eventColor;
                }
              }
            }
            eventRow.appendChild(td);
          });
          tbody.appendChild(eventRow);
        });

      });
    }
  </script>
</body>
</html>
